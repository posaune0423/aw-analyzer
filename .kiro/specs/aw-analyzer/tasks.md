# Implementation Plan

- [x] 1. CLI の tick 実行とジョブ評価の最小経路を成立させる
- [x] 1.1 CLI がサブコマンドを解釈し、tick の開始/終了と終了コードを制御できる
  - 起動時に指定サブコマンドに応じた処理を選択できる
  - `tick` 実行の開始/終了を記録できる
  - CLI 引数が不正な場合に利用方法を提示できる
  - 致命的エラー時に非ゼロの終了コードで終了できる
  - _Requirements: 1.1, 1.3, 1.4, 1.5, 9.1_
- [x] 1.2 tick 内で "ジョブ評価→必要な処理→終了" までを決定的に実行できる
  - tick 実行で評価すべきジョブ群を決定できる
  - 各ジョブについて「実行すべきか」を評価できる
  - 実行対象ジョブは決定的な順序で評価/実行される
  - _Requirements: 1.2, 2.2, 2.3_

- [x] 2. 状態管理（永続化）と通知抑制（cooldown/冪等）の基盤を実装する
- [x] 2.1 状態ストアを永続化し、tick を跨いで読み書きできる
  - ジョブ実行判定と通知抑制に必要な状態を保持できる
  - 状態ストアの保存場所を設定で変更できる
  - 読み込み失敗時に「空状態で継続」または「明示的にエラー終了」を選択できる
  - 書き込み時にデータ破損を起こしにくい挙動を実現できる
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_
- [x] 2.2 ジョブごとの cooldown により通知連発を防げる
  - 通知すべき結果に対し、cooldown に基づいて通知可否を判定できる
  - cooldown 期間内は通知を送信しない
  - ジョブごとに独立した cooldown を適用できる
  - 状態が破損/欠落している場合に保守的な挙動で連発を避けられる
  - _Requirements: 4.1, 4.2, 4.3, 4.5_
- [x] 2.3 日次などの冪等キーにより同一単位の重複通知を防げる
  - 1日1回などの日付単位で重複通知を避けられる
  - 指定時刻以降の最初の tick で日次ジョブを1回だけ実行できる
  - _Requirements: 4.4, 8.2_
- [x] 2.4 状態ストアをユーザー操作で削除/初期化できる
  - 状態ストアを削除して初期化できる
  - _Requirements: 10.5_

- [x] 3. 通知（Notifier）を抽象化し、macOS/Slack へ配信できる
- [x] 3.1 (P) 通知ポートを介してタイトル/本文/通知音を通知できる
  - ジョブ結果からタイトル/本文を通知に含められる
  - 通知音が有効化されている場合に通知音指定を含められる
  - 通知失敗をエラーとして扱い、上位へ伝播できる
  - _Requirements: 3.1, 3.2, 3.3, 3.4_
- [x] 3.2 (P) 通知手段を差し替え可能にし、テスト用通知を用意できる
  - Notifier を差し替え可能にできる
  - 外部依存なしで "通知された事実" を検証できる
  - _Requirements: 3.5, 11.1_
- [x] 3.3 (P) Slack Incoming Webhook へ Markdown レポートを送信できる
  - Slack 通知が有効化されている場合に、Markdown レポートを送信できる
  - Slack 通知の宛先を設定で変更できる
  - Slack 通知が失敗した場合にエラーとして扱い記録できる
  - _Requirements: 14.1, 14.2, 14.3_
- [x] 3.4 (P) 外部通知（Slack 等）を無効化し、ローカル通知へフォールバックできる
  - 外部通知を無効化できる
  - 外部通知が無効な場合にローカル通知を継続できる
  - _Requirements: 10.7, 14.5_

- [x] 4. データ取得（Provider）を抽象化し、ActivityWatch と疎結合に連携する
- [x] 4.1 ActivityWatch の接続先を設定で切り替え、必要最小限の接続先にのみアクセスできる
  - ActivityWatch が利用可能な場合にメトリクス取得できる
  - ActivityWatch の接続先（base URL 等）を設定で変更できる
  - 明示的に設定した接続先以外へアクセスしない
  - _Requirements: 6.3, 6.5, 10.2_
- [x] 4.2 ActivityWatch の内部詳細を隠蔽し、期間/時間帯メトリクスを算出できる
  - ジョブが必要とするメトリクスを Provider 経由で取得できる
  - Provider の内部実装詳細（bucket/クエリ方言等）をジョブから隠蔽できる
  - 日次/当日/指定期間/特定時間帯のメトリクスを算出できる
  - 値欠損時はゼロ/不明として扱い、通知文やレポートを破綻させない
  - _Requirements: 6.1, 6.2, 7.1, 7.2, 7.3, 7.4, 7.5_
- [x] 4.3 ActivityWatch が利用できない場合に安全に失敗させるか代替データで継続できる
  - ActivityWatch が利用できない場合にジョブ実行を安全に失敗させられる
  - 代替データ（fixture）で継続できる
  - _Requirements: 6.4, 11.2_
- [x] 4.4 (P) 外部依存なしで Provider の挙動を検証できる fixture を用意する
  - 固定入力（fixture）に対して決定的なメトリクス結果を再現できる
  - _Requirements: 11.3_

- [x] 5. Job（ルール）を追加可能にし、通知/レポートのユースケースを実装する
- [x] 5.1 ジョブを一意に識別し、追加しても既存挙動を壊さずに拡張できる
  - ジョブが一意に識別できる ID を持つ
  - 実行すべきでないジョブはスキップできる
  - 新しいジョブ追加が既存ジョブの仕様を破壊しない
  - _Requirements: 2.1, 2.4, 2.5_
- [x] 5.2 日次サマリ通知ジョブを実装できる（指定時刻以降の最初の tick で1回）
  - "指定時刻以降の最初の tick" を実現できる
  - 日次の活動メトリクスから通知文を生成できる
  - _Requirements: 7.1, 8.1, 8.2_
- [x] 5.3 連続稼働などの閾値アラートジョブを実装できる（毎 tick 評価 + cooldown）
  - tick 毎に評価するジョブを実装できる
  - 条件が満たされたときのみ通知するジョブを実装できる
  - cooldown により通知連発を防げる
  - _Requirements: 8.3, 8.4, 4.1, 4.2_
- [x] 5.4 Markdown レポート生成ジョブを実装し、通知として配信できる
  - レポート生成ジョブ実行時に、指定期間の入力（メトリクス/要約）を作成できる
  - 同一入力と状態で決定的な結果（通知有無/本文）を返せる
  - _Requirements: 12.1, 11.3_

- [x] 6. AI 分析（OpenAI）と prompt 分離により Markdown レポートを生成できる
- [x] 6.1 (P) Prompt を別ファイルとして管理し、実行時に読み込める
  - Prompt を差し替え可能にし、変更しやすい形で管理できる
  - Prompt 欠落/読み込み失敗を設定不備として扱える
  - _Requirements: 13.1, 13.3_
- [x] 6.2 (P) AI 分析を有効化した場合に Markdown レポートを生成できる（OpenAI）
  - AI 分析が有効化されている場合に Analyzer 経由でレポート本文（Markdown）を生成できる
  - Analyzer 実装を差し替え可能にできる
  - _Requirements: 12.2, 12.4_
- [x] 6.3 AI 失敗時に決定的なフォールバックレポート生成または安全な失敗を選べる
  - AI 分析が利用できない/失敗した場合に代替レポート生成または安全な失敗を選べる
  - _Requirements: 12.3_
- [x] 6.4 レポートの Markdown フォーマットを "見やすい構造" で満たせる
  - 対象期間（開始/終了）と生成時刻を含められる
  - Summary と Key metrics を含められる
  - 変化点/異常がある場合に該当セクションを含められる
  - 欠損/不明値を破綻なく表現できる
  - _Requirements: 13.2, 13.3, 13.4, 13.5_
- [x] 6.5 外部に送る内容を要約/集約レポートに限定し、生データ送信を避けられる
  - 外部（インターネット）へ詳細イベント等の生データを送信しない
  - 外部通知（Slack 等）が有効な場合に外部へ送信する内容を要約/集約レポートに限定できる
  - _Requirements: 10.1, 10.6_

- [x] 7. スケジュール表現（起動頻度上限前提）と実行モデルの整合を取る
- [x] 7.1 tick 頻度を上限として、日次/毎tick/条件付きの両立を保証できる
  - 外部スケジューラの起動頻度（tick）を上限として実行制御できる
  - 起動頻度が低い場合でも誤通知や連発を避けられる
  - _Requirements: 8.1, 8.5_

- [x] 8. 可観測性（ログ/診断）とプライバシー配慮を実装する
- [x] 8.1 ログの冗長さを設定で切り替え、ジョブの実行/スキップ理由を記録できる
  - ジョブの実行/スキップ理由を記録できる
  - ログの冗長さ（quiet/verbose）を切り替えられる
  - _Requirements: 9.2, 9.5_
- [x] 8.2 Provider/Notifier の失敗時に、エラー内容と影響範囲を記録できる
  - Provider 失敗時にエラー内容と影響範囲（どのジョブ/どの取得）を記録できる
  - 通知発火の失敗時にエラー内容を記録できる
  - _Requirements: 9.3, 9.4_
- [x] 8.3 デバッグログ時に機微情報の出力を抑制できる
  - デバッグログが有効な場合に可能な限り機微情報の出力を抑制できる
  - _Requirements: 10.4_
- [x] 8.4 状態ストアの保存情報を最小限に抑えられる
  - 通知制御に必要なキー/時刻等に限定して状態を保存できる
  - _Requirements: 10.3_

- [x] 9. 外部依存なしの自動テストで決定性と主要フローを検証する
- [x] 9.1 Scheduler と should-run 判定を単体でテストできる
  - スケジューリング判定（should-run）を単体でテスト可能にする
  - _Requirements: 11.4_
- [x] 9.2 (P) fixture とテスト用実装で "tick 一巡" の決定性を検証できる
  - Bun 環境で自動テストを実行できる
  - 固定入力に対してメトリクス算出と通知判定を再現できる
  - 同一の入力と状態が与えられたときに決定的な結果（通知有無/本文）を返せる
  - _Requirements: 11.2, 11.3, 11.5_
- [x] 9.3 (P) Analyzer を差し替えた条件下で決定的なレポート文字列を検証できる
  - スタブ Analyzer を用いて同一入力で同一レポート文字列になることを検証できる
  - _Requirements: 12.5_
- [x] 9.4 外部通知を有効/無効に切り替えた場合の挙動を検証できる
  - 外部通知が無効な場合にローカル通知へフォールバックすることを検証できる
  - _Requirements: 14.5, 10.7_
